# 专题: 低代码平台的架构和思考

:::
12.04 由于最近面试被深挖了，先占个坑
:::

这篇文章的目标是结合我的经验说清楚这个东西到底是什么，并同时辅以 demo 项目和可用的代码。

由于这个项目是在公司做的，这里只能凭借个人的经验和记忆重新开发，但我相信经过自己的经验和沉淀出来的架构，会比之前做的项目更优秀

项目链接：https://github.com/Kevin031/lowcode-engine

## 是什么

低代码平台是指**管理员**通过在线的**拖拽**和**编排**，生成在生产环境可用的**组件**或**页面**。

它的组成必定包含：数据协议 + 源码组件 + 渲染引擎。

## 优缺点

优势：

- 1. 提效 + 自由度

- 2. 可视化 + 快速搭建和上线

- 3. 横向能力拓展

缺点：

- 1. 上手成本高，需要学习新规范

- 2. 前端框架的升级成本

- 3. 不好维护：定位问题，性能优化

- 4. 出码后的二次开发不可逆

## 定位和发力方向

以上缺点决定了低代码的产品想要获得成功和规模化的使用，必须在垂直方向上发力，例如

- 海报

- H5 活动

- 表单收集

它们的共同特点是**轻交互**和**轻逻辑**

## 模块划分

- 编辑器壳工程

- 工具栏

  - 保存和草稿

  - 微内核的架构：实现插件化的清空、回退、复制

- 物料区

  - 物料的分类：展示组件和容器组件（按基本类型）、源码组件和自定义组件（按架构）

  - 物料数据来源：基于 git 仓库、接口调用

- 画布

  - 渲染器（npm 包）

  - 渲染器在 iframe 方式嵌入，自带沙箱机制

- 表单生成器

  - 数据来源：物料信息

- 通信代理

  - 接管各个 iframe 和壳工程的通信

- 编译器

  - 产出 JSON 数据（重运行时）

  - 产出代码（React、Vue、SwiftUI，编译时，满足二开需求）

## 模块展开介绍（回头补充）

### 编辑器壳工程

**技术选型**：React + AntDesign 或 Vue + ViewUI

编辑器的 UI 界面主要包含了 4 大块：工具栏 + 物料区 + 画布 + 表单

通常来说它的重心在于表单，因此需要选择一个较为成熟的 UI 库来进行表单的渲染

编辑器之所以是壳工程，是因为以下的**所有模块**最终都会**聚合**在编辑上表现出来

聚合的方式比较灵活，包括接口数据、npm 包、iframe，具体方式如下

- 接口数据：物料信息（组件列表+表单协议）

- npm 包：通信代理、工具栏、插件、编译器（实际上可以通过项目内的 monorepo 子包导入开发）

- iframe：渲染器

### 物料管理

物料管理包含了两大部分：组件源码和组件描述（协议），组件描述又包含了组件的基本信息（编码和默认属性）和配置表单信息

因此，物料的数据最终有 2 个去向

1. 组件描述：通过后端接口的扫描和入库，以接口的形式提供给编辑器调用

2. 组件源码：通过发布 npm 包的形式，分别提供给画布和运行态应用打包导入

### 工具栏

工具栏我希望采用微内核的架构方案，核心只提供基础功能：保存和草稿

其余功能例如回退和恢复、变量管理、函数管理、接口管理，则是通过插件的形式接入进去

介绍一下这几块重要插件：

变量管理：可以给页面注册变量，通过模板字符串注入组件属性

函数管理：可以封装一些 JS 逻辑，通过模板字符串注入到组件事件 api

接口管理：可以封装一些请求接口的调用信息，通过各种钩子挂载到页面上，同时支持数据和变量产生的关联和绑定

### 画布和渲染器

由于低代码的数据最终需要在运行态中渲染出和设计态等同的效果，因此我是通过渲染器模块实现了代码的复用

画布和渲染器的关系可以这样理解：

画布 -> 入口页面 -> 渲染器(npm 包提供) -> 最终效果

运行态应用 -> 指定页面 -> 渲染器(npm 包提供) -> 最终效果

### 表单生成器

组件的物料信息中描述了表单信息，因此可以借助物料的表单信息去遍历出真实的表单 DOM 节点。

### 通信代理

信息需要在物料、画布、表单之间流转，因此我封装了一个通信代理来完成所有的信息传递，这也方便了捕获和排查问题。

### 编译器

默认情况下最终输出的是 JSON 数据，描述了组件树的信息。我们可以对 JSON 数据进行一定的加工，例如：标记哪些组件是需要出现在首屏的。

JSON 可以通过解析生成 AST，最终转换成代码。
