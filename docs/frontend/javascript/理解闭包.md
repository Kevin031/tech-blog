# 理解闭包

## 概念

闭包指的是可以访问到外层函数作用域的函数。

示例：

```js
function foo() {
  var name = "foo";
  function bar() {
    console.log("bar", name);
  }
  return bar;
}

var fn = foo();
fn(); // bar foo
```

在上述示例中，bar 函数可以访问到 foo 函数的变量 name，从而使它们绑定在一起（或者函数被引用包围）构成了闭包。

从广义上理解，JavaScript 的函数都是闭包。从狭义上理解，只有访问了外部变量的函数才称得上闭包。

## 闭包的创建和销毁

在 JavaScript 中，每当创建一个函数，闭包就会在函数创建的同时被创建出来。

在上述例子中，fn 函数调用完毕后，foo 函数会自动销毁，但是 foo 函数中的 name 不会被销毁。这是因为**垃圾回收机制**（GC）作用时，被另一个作用域引用的变量不会被回收，除非 bar 函数解除调用。如下所示

```js
fn = null; // 销毁fn防止内存泄露
```

## 拓展：通过闭包访问的对象一定不能被修改吗

```js
let foo = (function () {
  let obj = {
    a: 1,
    b: 2,
  };
  return {
    get(k) {
      return obj[k];
    },
  };
})();

// 给obj添加一个key:c
```

可以通过劫持原型链得到对象本身

```js
// 给obj添加一个key:c
Object.defineProperty(Object.prototype, "getThis", {
  get() {
    return this;
  },
});

// foo.get('c')
let obj = foo.get("getThis");
obj.c = 3;
console.log(foo.get("c"));
```

防范方式：断掉 obj 的原型链

```js
let foo = (function () {
  let obj = Object.create(null);
  obj.a = 1;
  obj.b = 2;
  // 或者采用下面这种方式断掉原型链
  // obj.__proto__ = null;
  return {
    get(k) {
      return obj[k];
    },
  };
})();
```
